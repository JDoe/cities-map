/*! cities-map - v0.0.1 - 2013-12-19
* https://github.com/TheDahv/cities-map
* Copyright (c) 2013 David Pierce; Licensed MIT */
(function(t,e){e["true"]=t,function(t,e){var a=t.CitiesMap=t.CitiesMap||{},r=a.Data={};r.loadCitiesData=function(t){var a,r,n,i=e.Deferred(),o="undefined"!=typeof Storage;return t=t||{},a={urlBase:"http://swoop.startupweekend.org"},r=e.extend(a,t),o&&localStorage.upGlobalMapExpiration&&localStorage.upGlobalMapExpiration>(new Date).getTime()?i.resolve(JSON.parse(localStorage.upGlobalMapData)):(n=e.get(""+r.urlBase+"/cities"),n.success(function(t){localStorage.upGlobalMapExpiration=(new Date).getTime()+5184e5,localStorage.upGlobalMapData=JSON.stringify(t),i.resolve(t)}),n.error(function(t){i.reject(t)})),i.promise()}}(window,jQuery),function(t){var e,a=window.google,r=window.jQuery,n=t.CitiesMap=t.CitiesMap||{},i=n.MapApi=function(e,a){var n={programsOfInterest:[],notificationUrl:"http://startupweekend.us1.list-manage.com/subscribe/post?u=77bee8d6876e3fd1aa815badb&amp;id=66eed7c427",disableDefaultUI:!0,styles:[{stylers:[{visibility:"off"}]},{featureType:"water",stylers:[{visibility:"on"},{color:"#e0ded8"}]},{featureType:"landscape",stylers:[{visibility:"on"},{color:"#f4f2eb"}]},{featureType:"administrative",stylers:[{visibility:"on"}]}]};return this.mapContainer=e,this.options=r.extend(n,a||{}),this.knownPrograms=["Bootcamp","LeanStartup","Marketing","Meetup","NEXT","SW Corporate","Social","Startup Weekend","Summit"],this.mapRef=null,this.mapPoints={},this.markers={},this.searchControl=null,this.writeMapToElement(),this.addFilterControlToMap(),t.MarkerClusterer&&(this.clusterManager=new t.MarkerClusterer(this.mapRef,[],{maxZoom:8,minimumClusterSize:4})),this};e=a&&a.maps?a.maps:void 0,e===void 0?window.alert("The Google Maps API is not available at this time. Please try again later"):(i.prototype.writeMapToElement=function(){var t,a,r=this,n=r.mapContainer,i=r.options;return i.center=i.center?new e.LatLng(i.center[0],i.center[1]):new e.LatLng(51.4791,0),i.zoom=i.zoom||2,i.mapTypeId=e.MapTypeId.ROADMAP,r.mapRef=new e.Map(n[0],i),r.infoWindowInstance=new e.InfoWindow({map:r.mapRef}),a=i.width||n.data("width")||600,t=i.height||n.data("height")||400,n.css("width",a),n.css("height",t),this.mapRef},i.prototype.createCityPoint=function(t,a){var r=new e.Marker({map:this.mapRef,position:new e.LatLng(t.location[0],t.location[1]),icon:"http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|00f09d|00f09d|00f09d"});return r.addListener("click",a),this.mapPoints[r.__gm_id]=t,this.markers[r.__gm_id]=r,this.clusterManager&&this.clusterManager.addMarker(r),r}),i.prototype.getMarkerShowHandler=function(){var t=this,e=t.mapRef,a=t.infoWindowInstance;return function(r){var n=this,i=n.__gm_id,o=t.mapPoints[i];return a.setContent(t.getCityInfoWindowContent(o)),a.open(e,n),r.stop(),!1}},i.prototype.getCityInfoWindowContent=function(t){var e=this,a="<div class='sw-cities-map'>",r=e.options.programsOfInterest;return 0===r.length&&(r=e.knownPrograms),a+=r.map(function(a){var r,n="",i=null;return t.upcoming_programs.some(function(t){return t.event_type===a?(i=t,!0):!1}),n+="<h1>"+a+" "+t.city+"</h1>",r="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=0|16*Math.random(),a="x"===t?e:8|3&e;return a.toString(16)}),n+=i&&i.events&&i.events.length>0?i.events.map(function(n){var i,o,s=e.formatDateString(n.start_date);return n.website&&n.website.length>0&&(i=/^https?\:\/\//.test(n.website)?a.website:"http://"+n.website),n.public_registration_url&&n.public_registration_url.length>0&&(o=/^https?:\/\//.test(n.public_registration_url)?n.public_registration_url:"http://"+n.public_registration_url),i=i||o||"http://www.startupweekend.org",o=o||i||"http://www.startupweekend.org","<div class='event-row'><p class='event-row__date'>"+s+(n.vertical.length>0?" - "+n.vertical:"")+"</p>"+"<span class='event-row__form-controls'><a href='"+i+"'>More Info</a></span>"+"<span class='event-row__form-controls'><a href='"+o+"'>Sign up</a></span>"+"<label for='"+r+"' class='event-row__notification-trigger'>Future event alerts</label>"+"<input id='"+r+"' type='checkbox' class='event-row__activate-form' />"+"<div class='event-row__form-target'>"+"<form action='"+e.options.notificationUrl+"' method='POST' target='_blank'>"+"<input type='hidden' name='CITY' value='"+t.city+"' />"+"<input type='hidden' name='MMERGE3' value='"+a+"' />"+"<input type='hidden' name='MMERGE4' value='"+n.vertical+"' />"+"<input type='text' name='EMAIL' placeholder='Email Address' /><input type='submit' name='Subscribe' value='Subscribe' />"+"</form></div>"+"</div>"}).join(""):"<div class='event-row'><p class='event-row__date'>No upcoming events</p><span class='event-row__form-controls'><a href=' "+e.programOrganizeRegistrationUrl(a)+"' target='_blank'>Organize an event</a></span>"+"<label for='"+r+"' class='event-row__notification-trigger'>Future event alerts</label>"+"<input id='"+r+"' type='checkbox' class='event-row__activate-form' />"+"<div class='event-row__form-target'>"+"<form action='"+e.options.notificationUrl+"' method='POST' target='_blank'>"+"<input type='hidden' name='CITY' value='"+t.city+"' />"+"<input type='hidden' name='MMERGE3' value='"+a+"' />"+"<input type='hidden' name='MMERGE4' value='' />"+"<input type='text' name='EMAIL' placeholder='Email Address'/><input type='submit' name='Subscribe' value='Subscribe' />"+"</form>"+"</div>"+"</div>"}).join(""),a+="</div>"},i.prototype.programOrganizeRegistrationUrl=function(t){switch(t){case"Startup Weekend":return"http://startupweekend.org/organizer/application/";case"NEXT":return"http://www.swnext.co/get-involved/apply";default:return"http://www.up.co/get-involved/become-leader"}},i.prototype.formatDateString=function(t){var e,a;return"string"==typeof t&&(t=new Date(t)),e=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"][t.getUTCDay()],a=["January","February","March","April","May","June","July","August","September","October","November","December"][t.getUTCMonth()],e+", "+a+" "+t.getUTCDate()},i.prototype.addFilterControlToMap=function(){var t=document.createElement("input"),a=this;t.type="search",t.setAttribute("results",""),t.className="map-city-filter",a.mapRef.controls[e.ControlPosition.TOP_RIGHT].push(t),r(t).on("search",o(a.handleSearchFilter,a)),r(t).on("keyup",o(a.handleSearchFilter,a)),a.searchControl=t};var o=function(t,e){var a=e;return function(){t.call(a,arguments)}};i.prototype.handleSearchFilter=function(){var t=this,a=t.searchControl.value,n=RegExp("^"+a,"i"),i=[];Object.keys(t.markers).forEach(function(e){""===a||n.test(t.mapPoints[e].city)?(t.markers[e].setVisible(!0),a.length>0&&i.push(e)):t.markers[e].setVisible(!1)});var o=r(t.searchControl);r(t.mapContainer).find(".search-results").remove();var s=r("<ul />",{"class":"search-results"}).css({position:"absolute",top:o.offset().top+o.height()-8,left:o.offset().left-8,width:o.outerWidth()-1});i.forEach(function(e){var a=t.mapPoints[e],n=[a.city];a.state&&n.push(a.state),a.country&&n.push(a.country),s.append(r("<li />").text(n.join(", ")).data("markerid",e))}),s.find("li").on("click",function(a){var n=r(a.currentTarget),i=n.data("markerid"),s=t.mapPoints[i];t.mapRef.setCenter(new e.LatLng(s.location[0],s.location[1])),t.mapRef.setZoom(12),o.val(r(n).text()),r(t.mapContainer).find(".search-results").remove()}),r(t.searchControl).after(s)}}(window),function(t,e){var a=e.Data;t.fn.citiesmap=function(r){var n=t(this),i=a.loadCitiesData(r);i.fail(function(t){window.alert(t)}),i.done(function(t){var a=new e.MapApi(n,r),i=a.getMarkerShowHandler();t.forEach(function(t){a.createCityPoint.call(a,t,i)})})}}(jQuery,CitiesMap)})({},function(){return this}());